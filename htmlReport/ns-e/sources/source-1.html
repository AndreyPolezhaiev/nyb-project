


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"> 
  <title>Coverage Report > AuthServiceImpl</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.norwayyachtbrockers.service.impl</a>
</div>

<h1>Coverage Summary for Class: AuthServiceImpl (com.norwayyachtbrockers.service.impl)</h1>

<table class="coverageStats">

<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">AuthServiceImpl</td>
<td class="coverageStat">
  <span class="percent">
    11,1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    3,4%
  </span>
  <span class="absValue">
    (4/117)
  </span>
</td>
</tr>
  <tr>
    <td class="name">AuthServiceImpl$$SpringCGLIB$$0</td>
  </tr>
<tr>
  <td class="name"><strong>Total</strong></td>
<td class="coverageStat">
  <span class="percent">
    11,1%
  </span>
  <span class="absValue">
    (1/9)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/22)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    3,4%
  </span>
  <span class="absValue">
    (4/117)
  </span>
</td>
</tr>
</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.norwayyachtbrockers.service.impl;
&nbsp;
&nbsp;import com.amazonaws.services.cognitoidp.AWSCognitoIdentityProvider;
&nbsp;import com.amazonaws.services.cognitoidp.model.*;
&nbsp;import com.auth0.jwt.JWT;
&nbsp;import com.auth0.jwt.interfaces.DecodedJWT;
&nbsp;import com.norwayyachtbrockers.dto.mapper.UserMapper;
&nbsp;import com.norwayyachtbrockers.dto.request.UserLoginRequestDto;
&nbsp;import com.norwayyachtbrockers.dto.request.UserRegistrationRequestDto;
&nbsp;import com.norwayyachtbrockers.dto.response.UserLoginResponseDto;
&nbsp;import com.norwayyachtbrockers.model.User;
&nbsp;import com.norwayyachtbrockers.model.enums.UserRoles;
&nbsp;import com.norwayyachtbrockers.service.AuthService;
&nbsp;import com.norwayyachtbrockers.service.UserService;
&nbsp;import com.norwayyachtbrockers.util.CognitoUtils;
&nbsp;import jakarta.transaction.Transactional;
&nbsp;import org.springframework.beans.factory.annotation.Value;
&nbsp;import org.springframework.stereotype.Service;
&nbsp;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.Arrays;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@Service
&nbsp;public class AuthServiceImpl implements AuthService {
&nbsp;
&nbsp;    private final UserService userService;
&nbsp;
&nbsp;    private final UserMapper userMapper;
&nbsp;
&nbsp;    private final AWSCognitoIdentityProvider cognitoClient;
&nbsp;
&nbsp;    @Value(&quot;${aws.cognito.userPoolId}&quot;)
&nbsp;    private String userPoolId;
&nbsp;
&nbsp;    @Value(&quot;${aws.cognito.clientId}&quot;)
&nbsp;    private String clientId;
&nbsp;
&nbsp;    @Value(&quot;${aws.cognito.clientSecret}&quot;)
&nbsp;    private String clientSecret;
&nbsp;
<b class="fc">&nbsp;    public AuthServiceImpl(UserService userService, UserMapper userMapper, AWSCognitoIdentityProvider cognitoClient) {</b>
<b class="fc">&nbsp;        this.userService = userService;</b>
<b class="fc">&nbsp;        this.userMapper = userMapper;</b>
<b class="fc">&nbsp;        this.cognitoClient = cognitoClient;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void register(UserRegistrationRequestDto request) {
&nbsp;
&nbsp;        try {
<b class="nc">&nbsp;            String secretHash = CognitoUtils.generateSecretHash(request.getEmail(), clientId, clientSecret);</b>
&nbsp;            // First, create the user
<b class="nc">&nbsp;            SignUpRequest signUpRequest = new SignUpRequest()</b>
<b class="nc">&nbsp;                    .withClientId(clientId)</b>
<b class="nc">&nbsp;                    .withSecretHash(secretHash)</b>
<b class="nc">&nbsp;                    .withUsername(request.getEmail())</b>
<b class="nc">&nbsp;                    .withPassword(request.getPassword())</b>
<b class="nc">&nbsp;                    .withUserAttributes(Arrays.asList(</b>
<b class="nc">&nbsp;                            new AttributeType().withName(&quot;email&quot;).withValue(request.getEmail()),</b>
<b class="nc">&nbsp;                            new AttributeType().withName(&quot;given_name&quot;).withValue(request.getFirstName()),</b>
<b class="nc">&nbsp;                            new AttributeType().withName(&quot;family_name&quot;).withValue(request.getLastName())</b>
&nbsp;                    ));
&nbsp;
<b class="nc">&nbsp;            SignUpResult signUpResult = cognitoClient.signUp(signUpRequest);</b>
&nbsp;
&nbsp;            // Auto-confirm the user
<b class="nc">&nbsp;            AdminConfirmSignUpRequest confirmSignUpRequest = new AdminConfirmSignUpRequest()</b>
<b class="nc">&nbsp;                    .withUserPoolId(userPoolId)</b>
<b class="nc">&nbsp;                    .withUsername(request.getEmail());</b>
&nbsp;
<b class="nc">&nbsp;            cognitoClient.adminConfirmSignUp(confirmSignUpRequest);</b>
&nbsp;
&nbsp;            // Add user to the &quot;ROLE_USER&quot; group
<b class="nc">&nbsp;            AdminAddUserToGroupRequest groupRequest = new AdminAddUserToGroupRequest()</b>
<b class="nc">&nbsp;                    .withUserPoolId(userPoolId)</b>
<b class="nc">&nbsp;                    .withUsername(request.getEmail())</b>
<b class="nc">&nbsp;                    .withGroupName(&quot;ROLE_USER&quot;);</b>
&nbsp;
<b class="nc">&nbsp;            cognitoClient.adminAddUserToGroup(groupRequest);</b>
&nbsp;
&nbsp;            // Perform automatic login to get the ID token
<b class="nc">&nbsp;            Map&lt;String, String&gt; authParams = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            authParams.put(&quot;USERNAME&quot;, request.getEmail());</b>
<b class="nc">&nbsp;            authParams.put(&quot;PASSWORD&quot;, request.getPassword());</b>
<b class="nc">&nbsp;            authParams.put(&quot;SECRET_HASH&quot;, secretHash);</b>
&nbsp;
<b class="nc">&nbsp;            InitiateAuthRequest authRequest = new InitiateAuthRequest()</b>
<b class="nc">&nbsp;                    .withAuthFlow(AuthFlowType.USER_PASSWORD_AUTH)</b>
<b class="nc">&nbsp;                    .withClientId(clientId)</b>
<b class="nc">&nbsp;                    .withAuthParameters(authParams);</b>
&nbsp;
<b class="nc">&nbsp;            InitiateAuthResult authResult = cognitoClient.initiateAuth(authRequest);</b>
<b class="nc">&nbsp;            String idToken = authResult.getAuthenticationResult().getIdToken();</b>
<b class="nc">&nbsp;            DecodedJWT jwt = JWT.decode(idToken);</b>
<b class="nc">&nbsp;            String userSub = jwt.getClaim(&quot;sub&quot;).asString();</b>
&nbsp;
&nbsp;            // Store user with Cognito sub
<b class="nc">&nbsp;            User user = userMapper.convertToUser(request);</b>
<b class="nc">&nbsp;            user.setCognitoSub(userSub);</b>
<b class="nc">&nbsp;            user.setUserRoles(UserRoles.ROLE_USER);</b>
&nbsp;
<b class="nc">&nbsp;            userService.saveUser(user);</b>
&nbsp;
<b class="nc">&nbsp;        } catch (Exception e) {</b>
&nbsp;            // Handle exceptions
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Error during registration or login: &quot; + e.getMessage(), e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    @Override
&nbsp;    public UserLoginResponseDto authenticate(UserLoginRequestDto request) {
&nbsp;        try {
<b class="nc">&nbsp;            String secretHash = CognitoUtils.generateSecretHash(request.getEmail(), clientId, clientSecret);</b>
<b class="nc">&nbsp;            Map&lt;String, String&gt; authParams = new HashMap&lt;&gt;();</b>
<b class="nc">&nbsp;            authParams.put(&quot;USERNAME&quot;, request.getEmail());</b>
<b class="nc">&nbsp;            authParams.put(&quot;PASSWORD&quot;, request.getPassword());</b>
<b class="nc">&nbsp;            authParams.put(&quot;SECRET_HASH&quot;, secretHash);</b>
&nbsp;
<b class="nc">&nbsp;            InitiateAuthRequest initiateAuthRequest = new InitiateAuthRequest()</b>
<b class="nc">&nbsp;                    .withAuthFlow(AuthFlowType.USER_PASSWORD_AUTH)</b>
<b class="nc">&nbsp;                    .withClientId(clientId)</b>
<b class="nc">&nbsp;                    .withAuthParameters(authParams);</b>
&nbsp;
<b class="nc">&nbsp;            InitiateAuthResult initiateAuthResult = cognitoClient.initiateAuth(initiateAuthRequest);</b>
<b class="nc">&nbsp;            String jwtToken = initiateAuthResult.getAuthenticationResult().getIdToken();</b>
<b class="nc">&nbsp;            return new UserLoginResponseDto(jwtToken);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
<b class="nc">&nbsp;            System.err.println(&quot;Failed to authenticate: &quot; + e.getMessage());</b>
<b class="nc">&nbsp;            return new UserLoginResponseDto(&quot;Error during login, please check logs.&quot;);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void updateUserAttributesAndManageGroups(String username, String firstName, String lastName, String newRole,
&nbsp;                                                    String userPoolId) {
&nbsp;        // Step 1: Retrieve current user attributes
<b class="nc">&nbsp;        AdminGetUserRequest getUserRequest = new AdminGetUserRequest()</b>
<b class="nc">&nbsp;                .withUsername(username)</b>
<b class="nc">&nbsp;                .withUserPoolId(userPoolId);</b>
<b class="nc">&nbsp;        AdminGetUserResult userResult = cognitoClient.adminGetUser(getUserRequest);</b>
&nbsp;
&nbsp;        // Step 2: Retrieve current group memberships
<b class="nc">&nbsp;        AdminListGroupsForUserRequest listGroupsRequest = new AdminListGroupsForUserRequest()</b>
<b class="nc">&nbsp;                .withUsername(username)</b>
<b class="nc">&nbsp;                .withUserPoolId(userPoolId);</b>
<b class="nc">&nbsp;        AdminListGroupsForUserResult listGroupsResult = cognitoClient.adminListGroupsForUser(listGroupsRequest);</b>
&nbsp;
<b class="nc">&nbsp;        String currentRole = listGroupsResult.getGroups().stream()</b>
<b class="nc">&nbsp;                .findFirst() // Assuming one role per user scenario</b>
<b class="nc">&nbsp;                .map(GroupType::getGroupName)</b>
<b class="nc">&nbsp;                .orElse(null);</b>
&nbsp;
&nbsp;        // Step 3: Update user attributes if necessary
<b class="nc">&nbsp;        List&lt;AttributeType&gt; attributesToUpdate = new ArrayList&lt;&gt;();</b>
<b class="nc">&nbsp;        if (firstName != null &amp;&amp; !firstName.isEmpty() &amp;&amp; !firstName.equals(getAttributeValue(userResult, &quot;given_name&quot;))) {</b>
<b class="nc">&nbsp;            attributesToUpdate.add(new AttributeType().withName(&quot;given_name&quot;).withValue(firstName));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (lastName != null &amp;&amp; !lastName.isEmpty() &amp;&amp; !lastName.equals(getAttributeValue(userResult, &quot;family_name&quot;))) {</b>
<b class="nc">&nbsp;            attributesToUpdate.add(new AttributeType().withName(&quot;family_name&quot;).withValue(lastName));</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (!attributesToUpdate.isEmpty()) {</b>
<b class="nc">&nbsp;            AdminUpdateUserAttributesRequest updateAttributesRequest = new AdminUpdateUserAttributesRequest()</b>
<b class="nc">&nbsp;                    .withUserPoolId(userPoolId)</b>
<b class="nc">&nbsp;                    .withUsername(username)</b>
<b class="nc">&nbsp;                    .withUserAttributes(attributesToUpdate);</b>
<b class="nc">&nbsp;            cognitoClient.adminUpdateUserAttributes(updateAttributesRequest);</b>
&nbsp;        }
&nbsp;
&nbsp;        // Step 4: Manage user group membership
<b class="nc">&nbsp;        if (newRole != null &amp;&amp; !newRole.equals(currentRole)) {</b>
<b class="nc">&nbsp;            if (currentRole != null) {</b>
<b class="nc">&nbsp;                removeUserFromGroup(username, currentRole, userPoolId);</b>
&nbsp;            }
<b class="nc">&nbsp;            if (!newRole.isEmpty()) {</b>
<b class="nc">&nbsp;                addUserToGroup(username, newRole, userPoolId);</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // Step 5: Add user to database
<b class="nc">&nbsp;        Long id = userService.findUserIdByEmail(username);</b>
<b class="nc">&nbsp;        User user = new User();</b>
<b class="nc">&nbsp;        user.setId(id);</b>
<b class="nc">&nbsp;        user.setEmail(username);</b>
<b class="nc">&nbsp;        user.setFirstName(firstName);</b>
<b class="nc">&nbsp;        user.setLastName(lastName);</b>
<b class="nc">&nbsp;        user.setUserRoles(UserRoles.fromString(newRole));</b>
&nbsp;
<b class="nc">&nbsp;        userService.updateUser(user, id);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    @Transactional
&nbsp;    public void deleteUser(String username) {
&nbsp;        try {
&nbsp;            // First, attempt to delete the user from AWS Cognito
<b class="nc">&nbsp;            deleteUserFromCognito(username);</b>
&nbsp;
&nbsp;            // If successful, delete the user from the local database
<b class="nc">&nbsp;            Long id = userService.findUserIdByEmail(username);</b>
<b class="nc">&nbsp;            userService.deleteById(id);</b>
<b class="nc">&nbsp;        } catch (Exception e) {</b>
&nbsp;            // Log the error and handle it, possibly rethrowing if the operation should be known to fail
<b class="nc">&nbsp;            throw new RuntimeException(&quot;Failed to delete user: &quot; + username, e);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    private void deleteUserFromCognito(String username) {
<b class="nc">&nbsp;        AdminDeleteUserRequest deleteRequest = new AdminDeleteUserRequest()</b>
<b class="nc">&nbsp;                .withUserPoolId(userPoolId)</b>
<b class="nc">&nbsp;                .withUsername(username);</b>
<b class="nc">&nbsp;        cognitoClient.adminDeleteUser(deleteRequest);</b>
&nbsp;    }
&nbsp;
&nbsp;
&nbsp;    private void addUserToGroup(String username, String groupName, String userPoolId) {
<b class="nc">&nbsp;        AdminAddUserToGroupRequest request = new AdminAddUserToGroupRequest()</b>
<b class="nc">&nbsp;                .withUsername(username)</b>
<b class="nc">&nbsp;                .withGroupName(groupName)</b>
<b class="nc">&nbsp;                .withUserPoolId(userPoolId);</b>
<b class="nc">&nbsp;        cognitoClient.adminAddUserToGroup(request);</b>
&nbsp;    }
&nbsp;
&nbsp;    private void removeUserFromGroup(String username, String groupName, String userPoolId) {
<b class="nc">&nbsp;        AdminRemoveUserFromGroupRequest request = new AdminRemoveUserFromGroupRequest()</b>
<b class="nc">&nbsp;                .withUsername(username)</b>
<b class="nc">&nbsp;                .withGroupName(groupName)</b>
<b class="nc">&nbsp;                .withUserPoolId(userPoolId);</b>
<b class="nc">&nbsp;        cognitoClient.adminRemoveUserFromGroup(request);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getAttributeValue(AdminGetUserResult userResult, String attributeName) {
<b class="nc">&nbsp;        return userResult.getUserAttributes().stream()</b>
<b class="nc">&nbsp;                .filter(attr -&gt; attr.getName().equals(attributeName))</b>
<b class="nc">&nbsp;                .findFirst()</b>
<b class="nc">&nbsp;                .map(AttributeType::getValue)</b>
<b class="nc">&nbsp;                .orElse(null);</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-04-30 22:07</div>
</div>
</body>
</html>
